<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>OPDS Browser</title>
    <% if (process.env.NODE_ENV === "development") { %>
    <script src="http://localhost:8090/webpack-dev-server.js"></script>
    <% } %>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
      body { margin: 0; }
    </style>
  </head>
  <body>
    <div id="opds-browser"></div>
    <% if (process.env.NODE_ENV === "development") { %>
    <script src="http://localhost:8090/dist/opds-browser.js"></script>
    <% } else { %>
    <script src="/opds-browser.js"></script>
    <% } %>
    <script>
      var getParam = function(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
      };

      var serializeParams = function(params) {
        if (Object.keys(params).length === 0) {
          return "";
        }

        return "?" + Object.keys(params).reduce(function(keys, key) {
          if (params[key]) {
            keys.push(key + "=" + encodeURIComponent(params[key]));
          }
          return keys;
        }, []).join("&");
      };

      var historyArgs = function(collectionUrl, bookUrl) {
        var params = {
          collection: collectionUrl,
          book: bookUrl
        };

        return [params, "", serializeParams(params)];
      }

      window.onpopstate = function(event) {
        var collection = null,
            book = null;

        if (event.state) {
          collection = event.state.collection || null;
          book = event.state.book || null;
        }

        // call setCollectionAndBook with skipOnNavigate = true
        // so that state isn't pushed every time it's popped
        browser.setCollectionAndBook(collection, book, true);
      };

      var pushHistory = function(collectionUrl, bookUrl) {
        window.history.pushState.apply(window.history, historyArgs(collectionUrl, bookUrl));
      };

      var startCollection = getParam("collection");
      var startBook = getParam("book");
      var browser = new OPDSBrowserApp({
        headerTitle: "OPDS Browser",
        collection: startCollection,
        book: startBook,
        proxyUrl: "/proxy",
        onNavigate: pushHistory,
        pathFor: function(collectionUrl, bookUrl) {
          return serializeParams({collection: collectionUrl, book: bookUrl});
        },
        pageTitleTemplate: function(collectionTitle, bookTitle) {
          var title = "OPDS Browser" + (collectionTitle ? " - " + collectionTitle : "");
          return title + (bookTitle ? " - " + bookTitle : "");
        }
      }, "opds-browser");

      if (startCollection || startBook) {
        window.history.replaceState.apply(window.history, historyArgs(startCollection, startBook));
      }
    </script>
  </body>
</html>
