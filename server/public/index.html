<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>OPDS Browser</title>
    <script src="http://localhost:8090/webpack-dev-server.js"></script>
    <style>
      body { margin: 0; }
    </style>
  </head>
  <body>
    <div id="opds-browser"></div>
    <script src="http://localhost:8090/dist/opds-browser.js"></script>
    <script>
      var getParameterByName = function(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
      };

      var queryStringFromParams = function(params) {
        var result = ["collection", "book"].reduce(function(str, key) {
          if (params[key]) {
            str += key + "=" + encodeURIComponent(params[key])
          }
          return str;
        }, "");

        return result ? ("?" + result) : "";
      };

      var historyArgs = function(collectionUrl, bookUrl) {
        var params = {
          collection: collectionUrl,
          book: bookUrl
        };

        return [params, "", queryStringFromParams(params)];
      }

      window.onpopstate = function(event) {
        if (event.state && event.state.collection) {
          // call loadCollection with skipOnFetch = true
          // so that state isn't pushed every time it's popped
          browser.loadCollection(event.state.collection, true, event.state.book);
        } else {
          browser.clearCollection();
        }
      };

      var pushHistory = function(collectionUrl, bookUrl) {
          window.history.pushState.apply(window.history, historyArgs(collectionUrl, bookUrl));
        };

      var startCollection = getParameterByName("collection");
      var startBook = getParameterByName("book");
      var browser = new OPDSBrowser({
        startCollection: startCollection,
        startBook: startBook,
        onFetchCollection: pushHistory,
        onDisplayBook: pushHistory
      }, "opds-browser");

      if (startCollection || startBook) {
        window.history.replaceState.apply(window.history, historyArgs(startCollection, startBook));
      }
    </script>
  </body>
</html>
